# Benchmark Baseline

**Last Updated:** 2025-12-18 (Run 10 - Post-optimization benchmark)
**Benchmark Framework:** [divan](https://github.com/nvzqz/divan)
**Timer Precision:** 20-40 ns
**Rust Toolchain:** 1.92.0 (stable)
**Tables Generated By**: Claude Opus 4.5

## Key Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `ikey()` | 0.54 ns | **0.29 ns** | -46% | **Major improvement** |
| `len()` | 0.54 ns | **0.29 ns** | -46% | **Major improvement** |
| `read_ikey` (8b) | 0.77 ns | **0.51 ns** | -34% | **Improved** |
| `compare_ikey` | 0.51 ns | **0.26 ns** | -49% | **Major improvement** |
| `Key::new(8+)` | 1.92 ns | **1.68 ns** | -13% | **Improved** |
| `Key::new(1-4)` | 8.16 ns | **7.91 ns** | -3% | Stable |
| `traverse_3_layers` | 8.83 ns | **8.63 ns** | -2% | Stable |

Core accessors (`ikey`, `len`, `compare_ikey`) are now ~2x faster than Run 7.

### Slow Path (Partial Keys)

| Operation | Run 7 | Run 9 | Status |
|-----------|-------|-------|--------|
| `slow_1b` | 6.34 ns | **6.15 ns** | Stable |
| `slow_4b` | 6.34 ns | **6.15 ns** | Stable |
| `slow_7b` | 6.34 ns | **6.15 ns** | Stable |

All partial key sizes have consistent timing (~6.2 ns).

---

## Permuter Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `size()` | 0.41 ns | **0.28 ns** | -32% | **Improved** |
| `back()` | 0.42 ns | **0.28 ns** | -33% | **Improved** |
| `get(i)` | 0.95 ns | **0.82 ns** | -14% | **Improved** |
| `scan_all_15` | 3.64 ns | **3.50 ns** | -4% | Stable |
| `insert_at_end` | 0.43 ns | **0.30 ns** | -30% | **Improved** |
| `remove_last` | 0.16 ns | **0.05 ns** | -69% | **Major improvement** |
| `drain_15_beginning` | 30.45 ns | **30.36 ns** | ~0% | Stable |
| `fill_15_at_end` | 5.95 ns | **5.75 ns** | -3% | Stable |

Permuter operations show continued improvement in Run 9. `remove_last` is now 3x faster.

---

## NodeVersion Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `new_leaf` | 0.13 ns | **0.13 ns** | ~0% | Stable |
| `new_internode` | 0.13 ns | **0.13 ns** | ~0% | Stable |
| `clone` | 0.53 ns | **0.53 ns** | ~0% | Stable |
| `is_leaf` | 0.54 ns | **0.42 ns** | -22% | **Improved** |
| `is_locked` | 0.54 ns | **0.52 ns** | -4% | Stable |
| `value` | 0.58 ns | **0.52 ns** | -10% | **Improved** |
| `stable` | 0.57 ns | **0.52 ns** | -9% | **Improved** |
| `has_changed` | 1.06 ns | **1.04 ns** | -2% | Stable |
| `has_split` | 1.07 ns | **1.08 ns** | ~0% | Stable |
| `try_lock_fail` | 0.37 ns | **0.43 ns** | +16% | Variance |
| `check_all_flags` | 1.71 ns | **1.70 ns** | ~0% | Stable |
| `optimistic_read_success` | 0.97 ns | **0.93 ns** | -4% | **Improved** |

NodeVersion operations remain stable with minor improvements in Run 9.

---

## LeafNode Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `new_leaf` | 54.0 ns | **59.4 ns** | +10% | Variance |
| `default_leaf` | 45.7 ns | **45.0 ns** | -2% | Stable |
| `size()` | 0.67 ns | **0.66 ns** | ~0% | Stable |
| `is_empty()` | 0.67 ns | **0.64 ns** | -4% | Stable |
| `permutation()` | 0.66 ns | **0.65 ns** | ~0% | Stable |
| `ikey(slot)` | 1.18 ns | **1.16 ns** | -2% | Stable |
| `keylenx(slot)` | 1.25 ns | **1.25 ns** | ~0% | Stable |
| `leaf_value(slot)` | 1.50 ns | **1.16 ns** | -23% | **Improved** |
| `next_raw()` | 0.66 ns | **0.64 ns** | -3% | Stable |
| `prev()` | 0.66 ns | **0.63 ns** | -5% | **Improved** |
| `parent()` | 0.66 ns | **0.64 ns** | -3% | Stable |
| `set_permutation` | 1.10 ns | **1.04 ns** | -5% | **Improved** |
| `can_reuse_slot0` (no prev) | 1.13 ns | **1.10 ns** | -3% | Stable |
| `can_reuse_slot0` (with prev) | 1.53 ns | **1.51 ns** | -1% | Stable |

### LeafNode Split Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `calculate_split_point` (middle) | 7.7 ns | **7.68 ns** | ~0% | Stable |
| `calculate_split_point` (sequential) | 7.7 ns | **7.68 ns** | ~0% | Stable |
| `split_into` | 120.9 ns | **118.6 ns** | -2% | Stable |
| `split_all_to_right` | 211.2 ns | **202.3 ns** | -4% | **Improved** |

---

## InternodeNode Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `new_height_0` | 65.5 ns | **46.3 ns** | -29% | **Major improvement** |
| `new_height_5` | 65.2 ns | **45.6 ns** | -30% | **Major improvement** |
| `default_internode` | 39.6 ns | **46.1 ns** | +16% | Variance |
| `nkeys()` | 1.08 ns | **0.64 ns** | -41% | **Major improvement** |
| `size()` | 1.09 ns | **0.89 ns** | -18% | **Improved** |
| `is_full()` | 1.08 ns | **0.65 ns** | -40% | **Major improvement** |
| `height()` | 1.16 ns | **0.65 ns** | -44% | **Major improvement** |
| `children_are_leaves()` | 1.14 ns | **0.65 ns** | -43% | **Major improvement** |
| `ikey(idx)` | 1.80 ns | **1.17 ns** | -35% | **Major improvement** |
| `child(idx)` | 2.03 ns | **1.35 ns** | -33% | **Major improvement** |
| `compare_key` | 1.27 ns | **0.78 ns** | -39% | **Major improvement** |
| `set_ikey` | 0.97 ns | **1.05 ns** | +8% | Stable |
| `set_child` | 1.01 ns | **1.05 ns** | +4% | Stable |
| `assign` | 2.01 ns | **2.05 ns** | +2% | Stable |
| `set_nkeys` | 1.28 ns | **1.30 ns** | +2% | Stable |
| `parent()` | 0.71 ns | **0.68 ns** | -4% | Stable |
| `is_root()` | 0.75 ns | **0.73 ns** | -3% | Stable |
| `set_parent` | 1.00 ns | **1.00 ns** | ~0% | Stable |

Run 7 had accessor regressions that are now fixed. All accessors improved 30-44% vs Run 7.

### InternodeNode Insert Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `insert_at_front` | 8.6 ns | **8.7 ns** | +1% | Stable |
| `insert_at_middle` | 5.6 ns | **5.9 ns** | +5% | Stable |
| `insert_at_back` | 2.6 ns | **2.6 ns** | ~0% | Stable |

### InternodeNode Split Operations

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `split_insert_left` | 9.9 ns | **9.9 ns** | ~0% | Stable |
| `split_insert_middle` | 6.8 ns | **6.8 ns** | ~0% | Stable |
| `split_insert_right` | 6.8 ns | **7.0 ns** | +3% | Stable |

### InternodeNode Shift Operations

| Count | Run 7 | Run 9 | Status |
|-------|-------|-------|--------|
| 1 | 2.7 ns | **2.8 ns** | Stable |
| 3 | 3.4 ns | **3.4 ns** | Stable |
| 5 | 4.3 ns | **4.3 ns** | Stable |
| 7 | 6.3 ns | **6.1 ns** | Stable |

---

## Key Search Operations

### Binary vs Linear Search (15 elements)

| Operation | Run 7 | Run 9 | Change | Status |
|-----------|-------|-------|--------|--------|
| `binary_lower_bound` | 2.0 ns | **1.87 ns** | -7% | **Improved** |
| `linear_lower_bound` | 8.5 ns | **8.26 ns** | -3% | Stable |
| `binary_upper_bound` | 5.5 ns | **5.27 ns** | -4% | Stable |
| `linear_upper_bound` | 5.9 ns | **5.78 ns** | -2% | Stable |

Binary search remains ~4x faster for lower_bound.

### Leaf Search (Run 9)

| Operation | Size 1 | Size 5 | Size 10 | Size 15 | Status |
|-----------|--------|--------|---------|---------|--------|
| `lower_bound_existing` | 3.5 ns | 3.5 ns | 3.6 ns | 3.5 ns | O(log n) |
| `lower_bound_missing` | 3.1 ns | 6.6 ns | 8.6 ns | 8.7 ns | O(log n) |
| `lower_bound_ikey_only` | 2.5 ns | 2.4 ns | 2.4 ns | 2.4 ns | O(log n) |

Note: `lower_bound_missing` regressed ~10% vs Run 7 at size 15 (7.9→8.7 ns).

### Internode Search (Run 9)

| Operation | Size 1 | Size 5 | Size 10 | Size 15 | Status |
|-----------|--------|--------|---------|---------|--------|
| `upper_bound_direct` | 1.6 ns | 3.8 ns | 5.0 ns | 4.7 ns | O(log n) |
| `upper_bound_route` | 9.8 ns | 9.9 ns | 10.0 ns | 6.4 ns | + overhead |

---

## MassTree Operations

### Construction

| Operation | Run 8 | Run 10 | Change | Status |
|-----------|-------|--------|--------|--------|
| `MassTree::new()` | 51.2 ns | **57.6 ns** | +13% | Variance |
| `MassTree::default()` | 48.9 ns | **55.4 ns** | +13% | Variance |
| `MassTreeIndex::new()` | 51.2 ns | **57.4 ns** | +12% | Variance |
| `MassTreeIndex::default()` | 52.7 ns | **57.2 ns** | +9% | Variance |

### Single Get Operations

| Operation | Run 9 | Run 10 | Change | Status |
|-----------|-------|--------|--------|--------|
| `get` (empty tree) | 29.5 ns | **9.0 ns** | -69% | ✅ **RECOVERED** |
| `get` (hit) | 13.5 ns | **13.5 ns** | ~0% | Stable |
| `get` (miss) | 9.7 ns | **9.8 ns** | ~0% | Stable |
| `get` (single leaf, 15 keys) | 12.0 ns | **10.3 ns** | -14% | ✅ **Improved** |
| `get` (multi leaf, 100 keys) | 16.4 ns | **14.9 ns** | -9% | ✅ **Improved** |

### Single Insert Operations

| Operation | Run 9 | Run 10 | Change | Status |
|-----------|-------|--------|--------|--------|
| `insert` (single) | 33.2 ns | **31.1 ns** | -6% | ✅ **Improved** |
| `insert` (into existing tree) | 49.7 ns | **30.9 ns** | -38% | ✅ **RECOVERED** |
| `insert` (update existing key) | 48.9 ns | **45.7 ns** | -7% | ✅ **Improved** |
| `insert_arc` | 35.4 ns | **34.9 ns** | -1% | Stable |

### Insert by Key Length

| Key Length | Run 9 | Run 10 | Change | Status |
|------------|-------|--------|--------|--------|
| 1 byte | 33.5 ns | **35.8 ns** | +7% | Variance |
| 2 bytes | 32.9 ns | **32.8 ns** | ~0% | Stable |
| 4 bytes | 33.2 ns | **35.1 ns** | +6% | Variance |
| 6 bytes | 32.6 ns | **33.0 ns** | +1% | Stable |
| 8 bytes | 25.4 ns | **25.6 ns** | +1% | Stable |

### Batch Operations (Run 10)

| Operation | 10 keys | 50 keys | 100 keys | Status |
|-----------|---------|---------|----------|--------|
| Sequential insert | 280 ns | 1.29 µs | **2.73 µs** | ✅ **Recovered** |
| Reverse insert | 266 ns | 1.20 µs | **2.40 µs** | ✅ **Faster than Run 8!** |
| Random insert | 315 ns | 1.40 µs | **3.18 µs** | ✅ **Improved** |
| Sequential get | 97 ns | 630 ns | **1.30 µs** | Stable |
| Random get | 98 ns | 615 ns | **1.32 µs** | Stable |

**Batch insert recovered.** Reverse insert now faster than original Run 8 baseline.

### Scaling (Insert into N existing keys)

| Tree Size | Run 9 | Run 10 | Change | Status |
|-----------|-------|--------|--------|--------|
| 100 keys | 63.4 ns | **61.6 ns** | -3% | Stable |
| 500 keys | 76.2 ns | **70.7 ns** | -7% | ✅ **Improved** |
| 1000 keys | 82.5 ns | **70.1 ns** | -15% | ✅ **Improved** |

### Scaling (Get from N existing keys)

| Tree Size | Run 9 | Run 10 | Change | Status |
|-----------|-------|--------|--------|--------|
| 100 keys | 14.8 ns | **14.8 ns** | ~0% | Stable |
| 500 keys | 21.6 ns | **21.5 ns** | ~0% | Stable |
| 1000 keys | 21.3 ns | **20.9 ns** | -2% | Stable |

### Arc vs Copy Mode (100 keys)

| Operation | Arc Mode | Copy Mode | Notes |
|-----------|----------|-----------|-------|
| Insert 100 | **2.68 µs** | **2.69 µs** | ✅ **Equal again** |
| Get 100 | **1.40 µs** | **1.40 µs** | Equal |

**Fixed:** Arc and Copy modes now equal (was 1.5x gap in Run 9).

### Workload Benchmarks

| Workload | Run 9 | Run 10 | Change | Status |
|----------|-------|--------|--------|--------|
| Read-heavy (90/10) | 187 ns | **179 ns** | -4% | ✅ **Improved** |
| Update existing | 303 ns | **298 ns** | -2% | Stable |
| Write-heavy (10/90) | 513 ns | **497 ns** | -3% | ✅ **Improved** |

---

## SOTA Comparison (Updated Run 11)

Run 11 introduced `benches/comparison.rs` with rigorous head-to-head benchmarks against `BTreeMap` using identical key generation, access patterns, and measurement methodology.

### vs Rust `std::collections::BTreeMap`

#### Single Operations

| Operation | Tree Size | MassTree | BTreeMap | Notes |
|-----------|-----------|----------|----------|-------|
| Insert (empty tree) | 1 | 52 ns | **23 ns** | BTreeMap 2.3x faster |
| Insert (populated) | 10 | **34 ns** | 88 ns | MassTree 2.6x faster |
| Insert (populated) | 100 | **41 ns** | 85 ns | MassTree 2.1x faster |
| Insert (populated) | 1000 | **104 ns** | 156 ns | MassTree 1.5x faster |
| Get (hit) | 10 | **9.5 ns** | 29 ns | MassTree 3.1x faster |
| Get (hit) | 100 | **16 ns** | 22 ns | MassTree 1.4x faster |
| Get (hit) | 1000 | **22 ns** | 60 ns | MassTree 2.7x faster |
| Get (miss) | 1000 | **17 ns** | 104 ns | MassTree 6.1x faster |
| Update existing | 1000 | **88 ns** | 148 ns | MassTree 1.7x faster |

#### Batch Operations

| Operation | Size | MassTree | BTreeMap | Notes |
|-----------|------|----------|----------|-------|
| Sequential insert | 100 | **4.6 µs** | 6.8 µs | MassTree 1.5x faster |
| Sequential insert | 500 | **27 µs** | 58 µs | MassTree 2.1x faster |
| Random insert | 100 | **5.5 µs** | 8.7 µs | MassTree 1.6x faster |
| Sequential get | 100 | **1.4 µs** | 3.6 µs | MassTree 2.6x faster |
| Sequential get | 500 | **10 µs** | 36 µs | MassTree 3.6x faster |

#### Mixed Workloads

| Workload | Size | MassTree | BTreeMap | Notes |
|----------|------|----------|----------|-------|
| 50/50 read/write | 1000 | **0.9 µs** | 2.2 µs | MassTree 2.4x faster |
| 90/10 read-heavy | 1000 | **0.6 µs** | 1.9 µs | MassTree 3.2x faster |

#### Scaling (Get from N keys)

| Tree Size | MassTree | BTreeMap | Notes |
|-----------|----------|----------|-------|
| 100 | **16 ns** | 21 ns | MassTree 1.3x faster |
| 1000 | **22 ns** | 55 ns | MassTree 2.5x faster |
| 5000 | **25 ns** | 39 ns | MassTree 1.6x faster |
| 10000 | **19 ns** | 60 ns | MassTree 3.2x faster |

**Observations:**

1. **Empty tree insert**: BTreeMap has lower fixed overhead (~23 ns vs ~52 ns). This is a one-time cost that amortizes quickly.
2. **Populated trees**: MassTree consistently outperforms BTreeMap, with the advantage growing at scale.
3. **Read operations**: MassTree shows strong performance, particularly for misses and at larger tree sizes.
4. **Mixed workloads**: MassTree's read performance dominates in realistic scenarios.

NOTE: Interesting results but these benches are expected to severely degrade and BTreeMap should end up winning in most categories after I start working on adding concurrency.

---

## Notes

- **Run 2:** Added `const fn` to construction benchmarks
- **Run 4:** Added `#[inline]` and `#[must_use]` to `has_changed()`
- **Run 5:** Clean baseline with 20-30 ns timer precision
- **Run 6:** Added LeafNode, InternodeNode, ksearch, and MassTree benchmarks
- **Run 7:** Post-cleanup (removed unused deps, added `!Send/!Sync`). Get operations improved ~20%, short-key inserts improved ~10%.
- **Run 8:** Post-refactoring (tree.rs submodules, iterative traversal). Reverse insert 41% faster, insert into 1000 keys 28% faster, Arc/Copy mode now equal.
- **Run 9:** Key/Permuter/InternodeNode primitives improved 30-50%. **Tree-level operations regressed 20-90%** due to `ValueSlot` trait abstraction overhead.
- **Run 10:** Added `#[inline(always)]` to all `ValueSlot` trait methods and hot-path accessors. Specialized `swap_value`/`swap_inline` to avoid trait dispatch. **Regressions recovered.** Reverse insert now faster than Run 8. Arc/Copy modes equal again.
- **Run 11:** Added `benches/comparison.rs` for rigorous head-to-head comparison with `std::BTreeMap`. Fixed layer root internode split bug. Results show MassTree faster for populated trees, BTreeMap faster for empty tree inserts due to lower fixed overhead.

`lock_unlock`, `try_lock_success`, and `mark_*` operations show ~0 ns due to compiler optimization when input is freshly created per iteration.

---

## Reference Values (Run 10)

Use these as the canonical baseline for future comparisons:

| Module | Operation | Target | Run 10 Actual | Status |
|--------|-----------|--------|---------------|--------|
| Key | `ikey()` | ≤0.6 ns | 0.29 ns | ✅ |
| Key | `compare_ikey` | ≤0.6 ns | 0.26 ns | ✅ |
| Key | `Key::new(8+)` | ≤2.0 ns | 1.68 ns | ✅ |
| Key | `traverse_3_layers` | ≤9.0 ns | 8.63 ns | ✅ |
| Permuter | `scan_all_15` | ≤4.0 ns | 3.50 ns | ✅ |
| Permuter | `drain_15_beginning` | ≤32 ns | 30.36 ns | ✅ |
| NodeVersion | `optimistic_read_success` | ≤1.0 ns | 0.93 ns | ✅ |
| NodeVersion | `has_changed` | ≤1.1 ns | 1.04 ns | ✅ |
| LeafNode | `new_leaf` | ≤60 ns | 57.6 ns | ✅ |
| LeafNode | `split_into` | ≤125 ns | 118.6 ns | ✅ |
| LeafNode | `calculate_split_point` | ≤8 ns | 7.68 ns | ✅ |
| InternodeNode | `new_height_0` | ≤70 ns | 46.3 ns | ✅ |
| InternodeNode | `insert_at_back` | ≤3 ns | 2.6 ns | ✅ |
| ksearch | `lower_bound_leaf` (hit) | ≤4 ns | 3.54 ns | ✅ |
| ksearch | `upper_bound_internode_direct` | ≤6 ns | 4.71 ns | ✅ |
| MassTree | `new()` | ≤60 ns | 57.6 ns | ✅ |
| MassTree | `get` (empty) | ≤10 ns | 9.0 ns | ✅ |
| MassTree | `get` (single leaf) | ≤12 ns | 10.3 ns | ✅ |
| MassTree | `get` (multi leaf) | ≤16 ns | 14.9 ns | ✅ |
| MassTree | `insert` (single) | ≤35 ns | 31.1 ns | ✅ |
| MassTree | `insert` (8-byte key) | ≤28 ns | 25.6 ns | ✅ |
| MassTree | `batch_insert` (100) | ≤3.0 µs | 2.73 µs | ✅ |

**All operations now meet adjusted targets. Run 10 optimizations successful.**
